---
title: "Kuma UI はどのように React Sever Components をサポートしているのか"
emoji: "🐻‍❄️"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["css", "nextjs", "react", "kumaui"]
published: false
---

この記事は [READYFOR Advent Calendar 2023](https://qiita.com/advent-calendar/2023/readyfor) の20日目の記事です。

## はじめに

こんにちは。READYFOR でフロントエンドエンジニアとして働いている菅原（[@kotarella1110](https://twitter.com/kotarella1110)）です！
私たちのプロダクトでは CSS ライブラリとして Emotion を採用していますが、ランタイムでのパフォーマンス上の問題や App Router 非対応等の理由から、ゼロランタイム CSS ライブラリへの移行を検討しています。このような背景から、ゼロランタイム CSS に関する話題が社内で頻繁に取り上げられています。
本記事では、その中でも私がメンテナとして関わっている [Kuma UI](https://www.kuma-ui.com) がどのように React Server Components をサポートしているかを詳しくご紹介します。

## Kuma UI ?

Kuma UI は、新しい手法である Hybrid Approach を採用した CSS in JS ライブラリです。
この手法では、静的に解析可能なスタイルはビルド時に抽出し、動的に変化するスタイルだけを JavaScript のランタイムで処理します。
これにより、Chakra UI などの従来型のランタイム CSS-in-JS の書き味を維持することを実現しています。

```tsx
function App() {
  const [checked, toggle] = useReducer((state) => !state, false);
  return (
    <Box>
      <Text
        fontSize="24px" // 静的に解析可能ためゼロランタイムで処理
        color={checked ? "red" : "blue"} // 動的に変化する値のためランタイムで処理
      >
        Hello World
      </Text>
      <Button onClick={toggle}>Click Me</Button>
    </Box>
  );
}
```

Kuma UI の詳細については Kuma UI 作者である poteboy さんの記事を、

https://zenn.dev/poteboy/articles/d94573793d56ed#hybrid-css-in-js-%E3%81%A8%E3%81%AF%E4%BD%95%E3%81%8B

Hybrid Approach の詳細については、メンテナである yuku さんの記事をご覧ください。

https://zenn.dev/yuku/articles/dd4c5c9c7299aa

## 「React Server Components のサポート」の定義

先ず、言葉の定義を確認しておきましょう。

CSS in JS ライブラリが Next.js の App Router をサポートしているからといって、Server Components として動作するとは限りません。
以下は、 Next.js の公式ドキュメントにおいて App Router に対応した CSS-in-JS ライブラリの一覧が示されています。

https://nextjs.org/docs/app/building-your-application/styling/css-in-js｀

この一覧には、styled-components や Material UI といったランタイム CSS in JS ライブラリが含まれていますが、これらは Client Components としてのみ動作します。例えば、[Material UI では、全てのコンポーネントに `"use client"` ディレクティブを含めることで](https://mui.com/blog/mui-next-js-app-router)、Next.js の App Router をサポートしていています。

本記事での「React Server Components のサポート」とは、CSS in JS ライブラリが Server Components として動作することを指しています。

## 何故ランタイム CSS ライブラリは React Server Components をサポートできないのか？

では、なぜランタイム CSS ライブラリは Server Components をサポートできないのでしょうか？
結論から言うと、[DOM などのブラウザ専用 API は使用できない](https://github.com/reactjs/rfcs/blob/main/text/0188-server-components.md#capabilities--constraints-of-server-and-client-components)ためです。
ランタイム　CSS　ライブラリは、JS　で記述されたスタイルを　CSS　文字列に変換し、DOM　操作によってそれらを　style　タグに挿入します。しかし、Server Components では　DOM　などのブラウザ専用 API は使用できないため、これらのライブラリは Server Components として動作させることができません。

## Kuma UI も React Server Components をサポートしていないのでは？

ここで「Kuma UI は動的なスタイルを含む場合にランタイムで処理するため、Server Component として動作しないのでは？」という疑問が生まれてくると思います。
これは半分正解で、半分誤りです。
正確には、「静的なスタイルのみの場合は Server Component として動作するが、動的なスタイルを含む場合のみ Client Component として動作する」と言えます。
その理由は、動的なスタイルを含む場合に Client Component に切り替わるためです。次のセクションで、詳細を見ていきましょう。

## Kuma UI はどのように React Server Components を対応しているのか

Kuma UI の `Flex` や `Button` といった全てのコンポーネントは、ビルド時に `Box` コンポーネントに変換されます。
そのため、`Box` コンポーネントは Hybrid Approach の中核を担う重要なコンポーネントとなっています。
`Box` コンポーネントの実装を確認することで、Server Components への対応内容が明確になります。

https://github.com/kuma-ui/kuma-ui/blob/%40kuma-ui/core%401.5.4/packages/core/src/components/Box/react/index.tsx#L14-L20

対応内容は非常にシンプルです。`Box` コンポーネントは、指定された props がすべて静的解析可能な場合には `"use client"` ディレクティブを含まない [`StaticBox`](https://github.com/kuma-ui/kuma-ui/blob/%40kuma-ui/core%401.5.4/packages/core/src/components/Box/react/StaticBox.tsx) というコンポーネントを返し、静的解析できない動的な props が存在する場合には `"use client"` ディレクティブを含む [`DynamicBox`](https://github.com/kuma-ui/kuma-ui/blob/%40kuma-ui/core%401.5.4/packages/core/src/components/Box/react/DynamicBox.tsx) という Client Components を返します。
補足として、`StaticBox` は Client Component にも Server Component にもなり得ます。どちらになるかは、`Box` を import しているコンポーネントに `"use client"` ディレイクティブの境界があるかないかに依存します。
